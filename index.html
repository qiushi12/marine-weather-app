<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·ä¸Šé£ç”µçª—å£æœŸ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f8ff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #003366;
        }
        .map-container {
            height: 400px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .coordinates {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #002244;
        }
        .chart-container {
            margin-top: 20px;
            position: relative;
            height: 500px;
        }
        .info-panel {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        .daily-max {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .daily-max-item {
            background-color: #e6f2ff;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .error {
            color: red;
            padding: 10px;
            background-color: #ffe6e6;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .data-table th {
            background-color: #003366;
            color: white;
        }
        /* æ»šåŠ¨è¡¨æ ¼å®¹å™¨ */
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        /* æŠ˜å è¡¨æ ¼æ ·å¼ */
        .collapsible {
            background-color: #003366;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            margin-top: 5px;
        }
        .collapsible:hover {
            background-color: #002244;
        }
        .collapsible:after {
            content: '\25BC';
            float: right;
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }
        .collapsible.active:after {
            transform: rotate(180deg);
        }
        .content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: white;
        }
        .content.active {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .summary-table th {
            background-color: #003366;
            color: white;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* å¯¼èˆªæ æ ·å¼ */
        .nav-tabs {
            display: flex;
            margin-top: 20px;
            border-bottom: 1px solid #ccc;
        }
        .nav-tab {
            padding: 10px 20px;
            background-color: #e0e0e0;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .nav-tab.active {
            background-color: #003366;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .risk-table-container {
            margin-top: 10px;
            overflow-x: auto;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æµ·ä¸Šé£ç”µçª—å£æœŸ</h1>
        
        <div class="controls">
            <div class="coordinates">
                <label>çº¬åº¦:</label>
                <input type="number" id="latitude" step="any" value="23.224147">
                <label>ç»åº¦:</label>
                <input type="number" id="longitude" step="any" value="116.985192">
            </div>
            <button id="getWeather">è·å–æµ·æ´‹å¤©æ°”æ•°æ®</button>
        </div>
        
        <div id="map" class="map-container"></div>
        
        <div id="loading" class="loading">æ­£åœ¨è·å–æ•°æ®...</div>
        <div id="error" class="error"></div>
        
        <div id="results" style="display: none;">
            <div class="info-panel">
                <h2>ä½ç½®ä¿¡æ¯</h2>
                <p>æŸ¥è¯¢ä½ç½®: çº¬åº¦ <span id="lat-value"></span>, ç»åº¦ <span id="lon-value"></span></p>
                <p>æ•°æ®æ—¶é—´èŒƒå›´: <span id="time-range"></span></p>
                
                <!-- å¯¼èˆªæ  -->
                <div class="nav-tabs">
                    <div class="nav-tab active" data-tab="tab1">å¶è½®èµ·åŠ</div>
                    <div class="nav-tab" data-tab="tab2">ä½¿ç”¨åŠç¯®</div>
                    <div class="nav-tab" data-tab="tab3">å¶è½®å†…å·¥ä½œ</div>
                </div>
                
                <!-- å¶è½®èµ·åŠé£é™©è¡¨æ ¼ -->
                <div id="tab1" class="tab-content active">
                    <h3>å¶è½®èµ·åŠé£é™©è¯„ä¼°ï¼ˆè­¦å‘Šæ¡ä»¶ï¼šé£é€Ÿ&gt;6m/sæˆ–èƒ½è§åº¦&lt;0.1å…¬é‡Œï¼‰</h3>
                    <div id="lifting-risk-table-container" class="risk-table-container"></div>
                </div>
                
                <!-- ä½¿ç”¨åŠç¯®é£é™©è¡¨æ ¼ -->
                <div id="tab2" class="tab-content">
                    <h3>ä½¿ç”¨åŠç¯®é£é™©è¯„ä¼°ï¼ˆè­¦å‘Šæ¡ä»¶ï¼šé£é€Ÿ&gt;8m/sæˆ–æµªé«˜&gt;0.7mæˆ–èƒ½è§åº¦&lt;0.1å…¬é‡Œï¼‰</h3>
                    <div id="basket-risk-table-container" class="risk-table-container"></div>
                </div>
                
                <!-- å¶è½®å†…å·¥ä½œé£é™©è¡¨æ ¼ -->
                <div id="tab3" class="tab-content">
                    <h3>å¶è½®å†…å·¥ä½œé£é™©è¯„ä¼°ï¼ˆè­¦å‘Šæ¡ä»¶ï¼šé£é€Ÿ&gt;10m/sï¼‰</h3>
                    <div id="work-risk-table-container" class="risk-table-container"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="waveChart"></canvas>
            </div>
            
            <div class="info-panel">
                <h2>è¯¦ç»†å°æ—¶æ•°æ®</h2>
                <div id="daily-weather-container"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map').setView([23.224147, 116.985192], 6);
        
        // æ·»åŠ å¤šä¸ªåœ°å›¾ç“¦ç‰‡é€‰é¡¹ï¼Œæé«˜åŠ è½½æˆåŠŸç‡
        const tileLayers = [
            // OpenTopoMap ç“¦ç‰‡
            L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                             '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            }),
            // CartoDB ç“¦ç‰‡
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                             '&copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 19
            }),
            // OpenStreetMap ç“¦ç‰‡ï¼ˆé»˜è®¤é€‰é¡¹ï¼‰
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            })
        ];
        
        // å°è¯•æ·»åŠ ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç“¦ç‰‡å›¾å±‚
        let activeTileLayer = null;
        for (let i = 0; i < tileLayers.length; i++) {
            try {
                tileLayers[i].addTo(map);
                activeTileLayer = tileLayers[i];
                break;
            } catch (e) {
                console.warn(`Failed to load tile layer ${i}:`, e);
            }
        }
        
        // å¦‚æœæ‰€æœ‰ç“¦ç‰‡å›¾å±‚éƒ½åŠ è½½å¤±è´¥ï¼Œæ·»åŠ ä¸€ä¸ªé”™è¯¯å¤„ç†
        if (!activeTileLayer) {
            console.error("All tile layers failed to load");
            // æ·»åŠ ä¸€ä¸ªç®€å•çš„èƒŒæ™¯è‰²ä»¥ä¾¿ç”¨æˆ·èƒ½çœ‹åˆ°åœ°å›¾å®¹å™¨
            document.getElementById('map').style.backgroundColor = '#dddddd';
            document.getElementById('map').innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100%;font-size:18px;color:#666666;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
        }
        
        // æ·»åŠ æ ‡è®°
        let marker = L.marker([23.224147, 116.985192]).addTo(map);
        
        // ç‚¹å‡»åœ°å›¾è®¾ç½®åæ ‡
        map.on('click', function(e) {
            document.getElementById('latitude').value = e.latlng.lat.toFixed(6);
            document.getElementById('longitude').value = e.latlng.lng.toFixed(6);
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        });
        
        // è·å–å¤©æ°”æ•°æ®
        document.getElementById('getWeather').addEventListener('click', function() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            
            if (!lat || !lon) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦');
                return;
            }
            
            getWeatherData(lat, lon);
        });
        
        // å…¨å±€å˜é‡å­˜å‚¨å›¾è¡¨å®ä¾‹
        let waveChart = null;
        let chartData = null;
        
        // åŒæ—¶è·å–æµ·æ´‹å’Œå¤©æ°”æ•°æ®
        async function getWeatherData(latitude, longitude) {
            showLoading();
            
            try {
                // å¹¶è¡Œå‘é€ä¸¤ä¸ªAPIè¯·æ±‚
                const [marineResponse, weatherResponse] = await Promise.all([
                    fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${latitude}&longitude=${longitude}&hourly=wave_height&timezone=GMT&wind_speed_unit=ms&forecast_days=7`),
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=wind_speed_10m,wind_direction_10m,wind_gusts_10m,weather_code,temperature_80m,precipitation,visibility&timezone=GMT&wind_speed_unit=ms&forecast_days=7`)
                ]);
                
                if (!marineResponse.ok) {
                    throw new Error(`æµ·æ´‹APIé”™è¯¯: ${marineResponse.status}`);
                }
                
                if (!weatherResponse.ok) {
                    throw new Error(`å¤©æ°”APIé”™è¯¯: ${weatherResponse.status}`);
                }
                
                const marineData = await marineResponse.json();
                const weatherData = await weatherResponse.json();
                
                // åˆå¹¶æ•°æ®
                const combinedData = {
                    latitude: marineData.latitude,
                    longitude: marineData.longitude,
                    hourly: {
                        time: marineData.hourly.time,
                        wave_height: marineData.hourly.wave_height,
                        wind_speed_10m: weatherData.hourly.wind_speed_10m,
                        wind_direction_10m: weatherData.hourly.wind_direction_10m,
                        wind_gusts_10m: weatherData.hourly.wind_gusts_10m,
                        weather_code: weatherData.hourly.weather_code,
                        temperature_80m: weatherData.hourly.temperature_80m,
                        precipitation: weatherData.hourly.precipitation,
                        visibility: weatherData.hourly.visibility
                    }
                };
                
                displayWeatherData(combinedData);
            } catch (error) {
                console.error('Error fetching weather data:', error);
                showError('è·å–æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // æ˜¾ç¤ºå¤©æ°”æ•°æ®
        function displayWeatherData(data) {
            if (!data || !data.hourly) {
                showError('æ²¡æœ‰å¯ç”¨çš„æµ·æ´‹å¤©æ°”æ•°æ®');
                return;
            }
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('results').style.display = 'block';
            
            // è®¾ç½®ä½ç½®ä¿¡æ¯
            document.getElementById('lat-value').textContent = data.latitude.toFixed(6);
            document.getElementById('lon-value').textContent = data.longitude.toFixed(6);
            
            // å¤„ç†æ—¶é—´æ•°æ®
            const times = data.hourly.time.map(t => new Date(t));
            document.getElementById('time-range').textContent = 
                `${times[0].toLocaleString()} è‡³ ${times[times.length-1].toLocaleString()}`;
            
            // åˆ›å»ºé£é™©è¯„ä¼°è¡¨æ ¼
            createRiskAssessmentTables(times, data.hourly);
            
            // å¡«å……æ¯æ—¥å¤©æ°”æ•°æ®ï¼ˆæŠ˜å å¼ï¼‰
            fillDailyWeatherData(times, data.hourly);
            
            // ç»˜åˆ¶å›¾è¡¨ï¼Œæ˜¾ç¤ºæ³¢é«˜å’Œé£é€Ÿæ•°æ®
            chartData = data.hourly; // ä¿å­˜æ•°æ®ä»¥ä¾¿æ»šåŠ¨æ“ä½œ
            createWaveChart(times, data.hourly);
        }
        
        // åˆ›å»ºé£é™©è¯„ä¼°è¡¨æ ¼
        function createRiskAssessmentTables(times, hourlyData) {
            // è·å–å”¯ä¸€çš„æ—¥æœŸåˆ—è¡¨ï¼ˆæœªæ¥7å¤©ï¼‰
            const dates = [...new Set(times.map(t => t.toDateString()))]
                .map(d => new Date(d))
                .sort((a, b) => a - b)
                .slice(0, 7); // åªå–å‰7å¤©
            
            // åˆ›å»ºå¶è½®èµ·åŠé£é™©è¡¨æ ¼
            createLiftingRiskTable(dates, times, hourlyData);
            
            // åˆ›å»ºä½¿ç”¨åŠç¯®é£é™©è¡¨æ ¼
            createBasketRiskTable(dates, times, hourlyData);
            
            // åˆ›å»ºå¶è½®å†…å·¥ä½œé£é™©è¡¨æ ¼
            createWorkRiskTable(dates, times, hourlyData);
        }
        
        // åˆ›å»ºå¶è½®èµ·åŠé£é™©è¡¨æ ¼
        function createLiftingRiskTable(dates, times, hourlyData) {
            const container = document.getElementById('lifting-risk-table-container');
            
            // åˆ›å»ºè¡¨æ ¼å…ƒç´ 
            const table = document.createElement('table');
            table.className = 'data-table';
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // æ·»åŠ ç©ºçš„å·¦ä¸Šè§’å•å…ƒæ ¼
            /*const emptyHeader = document.createElement('th');
            emptyHeader.textContent = '';
            headerRow.appendChild(emptyHeader);*/
            
            // æ·»åŠ ç©ºç™½åˆ—
            const blankHeader = document.createElement('th');
            blankHeader.textContent = '';
            blankHeader.style.width = '20px';
            blankHeader.style.fontSize = '10px';
            headerRow.appendChild(blankHeader);
            
            // æ·»åŠ å°æ—¶åˆ—ï¼ˆ0æ—¶åˆ°23æ—¶ï¼‰
            for (let hour = 0; hour < 24; hour++) {
                const hourHeader = document.createElement('th');
                hourHeader.textContent = `${hour}æ—¶`;
                hourHeader.style.width = '20px';
                hourHeader.style.fontSize = '10px';
                headerRow.appendChild(hourHeader);
            }
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºè¡¨ä½“
            const tbody = document.createElement('tbody');
            
            // å®šä¹‰è¡Œæ ‡ç­¾
            const rowLabels = ['ä»Š', 'æ˜', 'å', '+3', '+4', '+5', '+6'];
            
            // ä¸ºæ¯ä¸€å¤©åˆ›å»ºä¸€è¡Œ
            dates.forEach((date, index) => {
                const row = document.createElement('tr');
                
                // æ·»åŠ æ—¥æœŸå•å…ƒæ ¼
                const dateCell = document.createElement('td');
                dateCell.textContent = rowLabels[index];
                dateCell.style.whiteSpace = 'nowrap';
                row.appendChild(dateCell);
                
                // æ·»åŠ ç©ºç™½å•å…ƒæ ¼
                /*const blankCell = document.createElement('td');
                blankCell.textContent = '';
                blankCell.style.width = '20px';
                row.appendChild(blankCell);*/
                
                // ä¸ºæ¯ä¸ªå°æ—¶åˆ›å»ºä¸€ä¸ªå•å…ƒæ ¼
                for (let hour = 0; hour < 24; hour++) {
                    const hourCell = document.createElement('td');
                    hourCell.textContent = '';
                    hourCell.style.padding = '4px';
                    hourCell.style.height = '25px';
                    hourCell.style.width = '20px';
                    
                    // æŸ¥æ‰¾è¯¥æ—¥æœŸå’Œå°æ—¶çš„æ•°æ®
                    const dataIndex = times.findIndex(t => 
                        t.getDate() === date.getDate() && 
                        t.getMonth() === date.getMonth() && 
                        t.getFullYear() === date.getFullYear() && 
                        t.getHours() === hour
                    );
                    
                    // å¦‚æœæ‰¾åˆ°æ•°æ®ä¸”æ»¡è¶³é£é™©æ¡ä»¶ï¼ˆé£é€Ÿ>6m/s æˆ– èƒ½è§åº¦<0.1å…¬é‡Œï¼‰ï¼Œåˆ™æ ‡è®°ä¸ºçº¢è‰²
                    if (dataIndex !== -1) {
                        const windSpeed = hourlyData.wind_speed_10m[dataIndex];
                        const visibility = hourlyData.visibility[dataIndex] !== null ? 
                            hourlyData.visibility[dataIndex] / 1000 : null; // è½¬æ¢ä¸ºå…¬é‡Œ
                        
                        if (windSpeed > 6 || (visibility !== null && visibility < 0.1)) {
                            hourCell.style.backgroundColor = '#ffcccc';
                        }
                        
                        hourCell.title = `é£é€Ÿ: ${windSpeed.toFixed(2)} m/s${visibility !== null ? `, èƒ½è§åº¦: ${visibility.toFixed(2)} å…¬é‡Œ` : ''}`;
                    }
                    
                    row.appendChild(hourCell);
                }
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // åˆ›å»ºä½¿ç”¨åŠç¯®é£é™©è¡¨æ ¼
        function createBasketRiskTable(dates, times, hourlyData) {
            const container = document.getElementById('basket-risk-table-container');
            
            // åˆ›å»ºè¡¨æ ¼å…ƒç´ 
            const table = document.createElement('table');
            table.className = 'data-table';
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // æ·»åŠ ç©ºçš„å·¦ä¸Šè§’å•å…ƒæ ¼
            /*const emptyHeader = document.createElement('th');
            emptyHeader.textContent = '';
            headerRow.appendChild(emptyHeader);*/
            
            // æ·»åŠ ç©ºç™½åˆ—
            const blankHeader = document.createElement('th');
            blankHeader.textContent = '';
            blankHeader.style.width = '20px';
            blankHeader.style.fontSize = '10px';
            headerRow.appendChild(blankHeader);
            
            // æ·»åŠ å°æ—¶åˆ—ï¼ˆ0æ—¶åˆ°23æ—¶ï¼‰
            for (let hour = 0; hour < 24; hour++) {
                const hourHeader = document.createElement('th');
                hourHeader.textContent = `${hour}æ—¶`;
                hourHeader.style.width = '20px';
                hourHeader.style.fontSize = '10px';
                headerRow.appendChild(hourHeader);
            }
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºè¡¨ä½“
            const tbody = document.createElement('tbody');
            
            // å®šä¹‰è¡Œæ ‡ç­¾
            const rowLabels = ['ä»Š', 'æ˜', 'å', '+3', '+4', '+5', '+6'];
            
            // ä¸ºæ¯ä¸€å¤©åˆ›å»ºä¸€è¡Œ
            dates.forEach((date, index) => {
                const row = document.createElement('tr');
                
                // æ·»åŠ æ—¥æœŸå•å…ƒæ ¼
                const dateCell = document.createElement('td');
                dateCell.textContent = rowLabels[index];
                dateCell.style.whiteSpace = 'nowrap';
                row.appendChild(dateCell);
                
                // æ·»åŠ ç©ºç™½å•å…ƒæ ¼
                /*const blankCell = document.createElement('td');
                blankCell.textContent = '';
                blankCell.style.width = '20px';
                row.appendChild(blankCell);*/
                
                // ä¸ºæ¯ä¸ªå°æ—¶åˆ›å»ºä¸€ä¸ªå•å…ƒæ ¼
                for (let hour = 0; hour < 24; hour++) {
                    const hourCell = document.createElement('td');
                    hourCell.textContent = '';
                    hourCell.style.padding = '4px';
                    hourCell.style.height = '25px';
                    hourCell.style.width = '20px';
                    
                    // æŸ¥æ‰¾è¯¥æ—¥æœŸå’Œå°æ—¶çš„æ•°æ®
                    const dataIndex = times.findIndex(t => 
                        t.getDate() === date.getDate() && 
                        t.getMonth() === date.getMonth() && 
                        t.getFullYear() === date.getFullYear() && 
                        t.getHours() === hour
                    );
                    
                    // å¦‚æœæ‰¾åˆ°æ•°æ®ä¸”æ»¡è¶³é£é™©æ¡ä»¶ï¼ˆé£é€Ÿ>8m/s æˆ– æµªé«˜>0.7m æˆ– èƒ½è§åº¦<0.1å…¬é‡Œï¼‰ï¼Œåˆ™æ ‡è®°ä¸ºçº¢è‰²
                    if (dataIndex !== -1) {
                        const windSpeed = hourlyData.wind_speed_10m[dataIndex];
                        const waveHeight = hourlyData.wave_height[dataIndex];
                        const visibility = hourlyData.visibility[dataIndex] !== null ? 
                            hourlyData.visibility[dataIndex] / 1000 : null; // è½¬æ¢ä¸ºå…¬é‡Œ
                        
                        if (windSpeed > 8 || waveHeight > 0.7 || (visibility !== null && visibility < 0.1)) {
                            hourCell.style.backgroundColor = '#ffcccc';
                        }
                        
                        hourCell.title = `é£é€Ÿ: ${windSpeed.toFixed(2)} m/s, æµªé«˜: ${waveHeight.toFixed(2)} ç±³${visibility !== null ? `, èƒ½è§åº¦: ${visibility.toFixed(2)} å…¬é‡Œ` : ''}`;
                    }
                    
                    row.appendChild(hourCell);
                }
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // åˆ›å»ºå¶è½®å†…å·¥ä½œé£é™©è¡¨æ ¼
        function createWorkRiskTable(dates, times, hourlyData) {
            const container = document.getElementById('work-risk-table-container');
            
            // åˆ›å»ºè¡¨æ ¼å…ƒç´ 
            const table = document.createElement('table');
            table.className = 'data-table';
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';
            
            // åˆ›å»ºè¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            // æ·»åŠ ç©ºçš„å·¦ä¸Šè§’å•å…ƒæ ¼
            /*const emptyHeader = document.createElement('th');
            emptyHeader.textContent = '';
            headerRow.appendChild(emptyHeader);*/
            
            // æ·»åŠ ç©ºç™½åˆ—
            const blankHeader = document.createElement('th');
            blankHeader.textContent = '';
            blankHeader.style.width = '20px';
            blankHeader.style.fontSize = '10px';
            headerRow.appendChild(blankHeader);
            
            // æ·»åŠ å°æ—¶åˆ—ï¼ˆ0æ—¶åˆ°23æ—¶ï¼‰
            for (let hour = 0; hour < 24; hour++) {
                const hourHeader = document.createElement('th');
                hourHeader.textContent = `${hour}æ—¶`;
                hourHeader.style.width = '20px';
                hourHeader.style.fontSize = '10px';
                headerRow.appendChild(hourHeader);
            }
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // åˆ›å»ºè¡¨ä½“
            const tbody = document.createElement('tbody');
            
            // å®šä¹‰è¡Œæ ‡ç­¾
            const rowLabels = ['ä»Š', 'æ˜', 'å', '+3', '+4', '+5', '+6'];
            
            // ä¸ºæ¯ä¸€å¤©åˆ›å»ºä¸€è¡Œ
            dates.forEach((date, index) => {
                const row = document.createElement('tr');
                
                // æ·»åŠ æ—¥æœŸå•å…ƒæ ¼
                const dateCell = document.createElement('td');
                dateCell.textContent = rowLabels[index];
                dateCell.style.whiteSpace = 'nowrap';
                row.appendChild(dateCell);
                
                // æ·»åŠ ç©ºç™½å•å…ƒæ ¼
               /* const blankCell = document.createElement('td');
                blankCell.textContent = '';
                blankCell.style.width = '20px';
                row.appendChild(blankCell);*/
                
                // ä¸ºæ¯ä¸ªå°æ—¶åˆ›å»ºä¸€ä¸ªå•å…ƒæ ¼
                for (let hour = 0; hour < 24; hour++) {
                    const hourCell = document.createElement('td');
                    hourCell.textContent = '';
                    hourCell.style.padding = '4px';
                    hourCell.style.height = '25px';
                    hourCell.style.width = '20px';
                    
                    // æŸ¥æ‰¾è¯¥æ—¥æœŸå’Œå°æ—¶çš„æ•°æ®
                    const dataIndex = times.findIndex(t => 
                        t.getDate() === date.getDate() && 
                        t.getMonth() === date.getMonth() && 
                        t.getFullYear() === date.getFullYear() && 
                        t.getHours() === hour
                    );
                    
                    // å¦‚æœæ‰¾åˆ°æ•°æ®ä¸”æ»¡è¶³é£é™©æ¡ä»¶ï¼ˆé£é€Ÿ>10m/sï¼‰ï¼Œåˆ™æ ‡è®°ä¸ºçº¢è‰²
                    if (dataIndex !== -1) {
                        const windSpeed = hourlyData.wind_speed_10m[dataIndex];
                        
                        if (windSpeed > 10) {
                            hourCell.style.backgroundColor = '#ffcccc';
                        }
                        
                        hourCell.title = `é£é€Ÿ: ${windSpeed.toFixed(2)} m/s`;
                    }
                    
                    row.appendChild(hourCell);
                }
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            container.innerHTML = '';
            container.appendChild(table);
        }
        
        // å¡«å……æ¯æ—¥å¤©æ°”æ•°æ®ï¼ˆæŠ˜å å¼ï¼‰
        function fillDailyWeatherData(times, hourlyData) {
            const container = document.getElementById('daily-weather-container');
            container.innerHTML = '';
            
            // æŒ‰æ—¥æœŸåˆ†ç»„æ•°æ®
            const groupedData = {};
            times.forEach((time, index) => {
                const dateKey = time.toDateString();
                if (!groupedData[dateKey]) {
                    groupedData[dateKey] = {
                        date: time,
                        hours: []
                    };
                }
                groupedData[dateKey].hours.push({
                    time: time,
                    wave_height: hourlyData.wave_height[index],
                    wind_speed_10m: hourlyData.wind_speed_10m[index],
                    wind_direction_10m: hourlyData.wind_direction_10m[index],
                    wind_gusts_10m: hourlyData.wind_gusts_10m[index],
                    weather_code: hourlyData.weather_code[index],
                    temperature_80m: hourlyData.temperature_80m[index],
                    precipitation: hourlyData.precipitation[index],
                    visibility: hourlyData.visibility[index]
                });
            });
            
            // è·å–å”¯ä¸€çš„æ—¥æœŸåˆ—è¡¨ï¼ˆæœªæ¥7å¤©ï¼‰
            const dates = Object.keys(groupedData)
                .map(d => new Date(d))
                .sort((a, b) => a - b)
                .slice(0, 7); // åªå–å‰7å¤©
            
            // ä¸ºæ¯ä¸€å¤©åˆ›å»ºæŠ˜å é¢æ¿
            dates.forEach((date, index) => {
                const dateKey = date.toDateString();
                const dayData = groupedData[dateKey];
                
                // è®¡ç®—æœ€å¤§é£é€Ÿå’Œæœ€å¤§æ³¢é«˜
                let maxWindSpeed = 0;
                let maxWaveHeight = 0;
                dayData.hours.forEach(hour => {
                    if (hour.wind_speed_10m > maxWindSpeed) maxWindSpeed = hour.wind_speed_10m;
                    if (hour.wave_height > maxWaveHeight) maxWaveHeight = hour.wave_height;
                });
                
                // åˆ›å»ºæŠ˜å æŒ‰é’®
                const button = document.createElement('button');
                button.className = 'collapsible';
                button.textContent = `${date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' })} - æœ€å¤§é£é€Ÿ: ${maxWindSpeed.toFixed(1)} m/s, æœ€å¤§æ³¢é«˜: ${maxWaveHeight.toFixed(1)} ç±³`;
                
                // åˆ›å»ºå†…å®¹åŒºåŸŸ
                const content = document.createElement('div');
                content.className = 'content';
                
                // åˆ›å»ºå°æ—¶æ•°æ®è¡¨æ ¼
                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å¤©æ°”</th>
                            <th>æ³¢é«˜ (ç±³)</th>
                            <th>é£é€Ÿ (ç±³/ç§’)</th>
                            <th>é£å‘</th>
                            <th>é˜µé£ (ç±³/ç§’)</th>
                            <th>æ¸©åº¦ (80ç±³) (Â°C)</th>
                            <th>é™æ°´ (mm)</th>
                            <th>èƒ½è§åº¦ (å…¬é‡Œ)</th>
                        </tr>
                    </thead>
                    <tbody id="hourly-data-body-${index}">
                    </tbody>
                `;
                
                // å¡«å……å°æ—¶æ•°æ®
                const tbody = table.querySelector(`#hourly-data-body-${index}`);
                dayData.hours.forEach(hour => {
                    const weatherInfo = getWeatherInfo(hour.weather_code);
                    const visibility = hour.visibility !== null ? 
                        (hour.visibility / 1000).toFixed(1) : 'N/A';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${hour.time.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit' })}</td>
                        <td>${weatherInfo.emoji} ${weatherInfo.description}</td>
                        <td>${hour.wave_height.toFixed(2)}</td>
                        <td>${hour.wind_speed_10m.toFixed(2)}</td>
                        <td>${getWindDirection(hour.wind_direction_10m)}</td>
                        <td>${hour.wind_gusts_10m.toFixed(2)}</td>
                        <td>${hour.temperature_80m.toFixed(1)}</td>
                        <td>${hour.precipitation.toFixed(1)}</td>
                        <td>${visibility}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                content.appendChild(table);
                
                // æ·»åŠ åˆ°å®¹å™¨
                container.appendChild(button);
                container.appendChild(content);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                button.addEventListener('click', function() {
                    this.classList.toggle('active');
                    content.classList.toggle('active');
                });
            });
        }
        
        // è·å–å¤©æ°”ä»£ç æè¿°å’Œemoji
        function getWeatherInfo(code) {
            const weatherInfo = {
                0: { emoji: 'â˜€ï¸', description: 'æ™´æœ—' },
                1: { emoji: 'â˜€ï¸', description: 'ä¸»è¦æ™´æœ—' },
                2: { emoji: 'â›…', description: 'éƒ¨åˆ†å¤šäº‘' },
                3: { emoji: 'â˜ï¸', description: 'é˜´å¤©' },
                45: { emoji: 'ğŸŒ«ï¸', description: 'æœ‰é›¾' },
                48: { emoji: 'ğŸŒ«ï¸', description: 'æœ‰éœœé›¾' },
                51: { emoji: 'ğŸŒ¦ï¸', description: 'å°é›¨' },
                53: { emoji: 'ğŸŒ§ï¸', description: 'ä¸­é›¨' },
                55: { emoji: 'ğŸŒ§ï¸', description: 'å¤§é›¨' },
                56: { emoji: 'ğŸŒ§ï¸', description: 'å°å†»é›¨' },
                57: { emoji: 'ğŸŒ§ï¸', description: 'å¤§å†»é›¨' },
                61: { emoji: 'ğŸŒ¨ï¸', description: 'å°é›ª' },
                63: { emoji: 'ğŸŒ¨ï¸', description: 'ä¸­é›ª' },
                65: { emoji: 'ğŸŒ¨ï¸', description: 'å¤§é›ª' },
                66: { emoji: 'ğŸŒ¨ï¸', description: 'å°å†»é›ª' },
                67: { emoji: 'ğŸŒ¨ï¸', description: 'å¤§å†»é›ª' },
                71: { emoji: 'ğŸŒ¨ï¸', description: 'å°é›ª' },
                73: { emoji: 'ğŸŒ¨ï¸', description: 'ä¸­é›ª' },
                75: { emoji: 'ğŸŒ¨ï¸', description: 'å¤§é›ª' },
                77: { emoji: 'â„ï¸', description: 'é›ªç²’' },
                80: { emoji: 'ğŸŒ¦ï¸', description: 'å°é˜µé›¨' },
                81: { emoji: 'ğŸŒ§ï¸', description: 'ä¸­é˜µé›¨' },
                82: { emoji: 'ğŸŒ§ï¸', description: 'å¤§é˜µé›¨' },
                85: { emoji: 'ğŸŒ¨ï¸', description: 'å°é˜µé›ª' },
                86: { emoji: 'ğŸŒ¨ï¸', description: 'å¤§é˜µé›ª' },
                95: { emoji: 'â›ˆï¸', description: 'é›·é›¨' },
                96: { emoji: 'â›ˆï¸', description: 'å°å†°é›¹é›·é›¨' },
                99: { emoji: 'â›ˆï¸', description: 'å¤§å†°é›¹é›·é›¨' }
            };
            
            return weatherInfo[code] || { emoji: 'â“', description: 'æœªçŸ¥' };
        }

        // è·å–é£å‘çš„ä¸­æ–‡è¡¨è¾¾
        function getWindDirection(degrees) {
            const directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
            const index = Math.round((degrees % 360) / 45) % 8;
            return directions[index];
        }
        
        // åˆ›å»ºæ³¢é«˜å›¾è¡¨
        function createWaveChart(times, hourlyData) {
            const ctx = document.getElementById('waveChart').getContext('2d');
            
            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œå…ˆé”€æ¯
            if (waveChart) {
                waveChart.destroy();
            }
            
            // ä½¿ç”¨æ‰€æœ‰æ•°æ®ï¼Œä¸è¿›è¡Œé™åˆ¶
            const chartTimes = times;
            const chartWaveHeights = hourlyData.wave_height;
            const chartWindSpeeds = hourlyData.wind_speed_10m;
            
            waveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartTimes.map(t => t.toLocaleString('zh-CN', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })),
                    datasets: [
                        {
                            label: 'æ³¢é«˜',
                            data: chartWaveHeights,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'é£é€Ÿ',
                            data: chartWindSpeeds,
                            borderColor: 'green',
                            backgroundColor: 'rgba(0, 128, 0, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 30
                            },
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ³¢é«˜ï¼ˆç±³ï¼‰'
                            }
                        },
                        y1: {
                            position: 'right',
                            title: {
                                display: true,
                                text: 'é£é€Ÿï¼ˆç±³/ç§’ï¼‰'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('results').style.display = 'none';
        }
        
        // åˆå§‹åŒ–æ—¶è·å–é»˜è®¤ä½ç½®çš„æ•°æ®
        window.addEventListener('load', function() {
            getWeatherData(23.224147, 116.985192);
        });
        
        // å¯¼èˆªæ åˆ‡æ¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.nav-tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰é€‰é¡¹
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
